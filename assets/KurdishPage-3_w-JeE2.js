import{c as V,r,a as Z,s as v,f as J,j as s}from"./index-C2Jj2ziF.js";import{H as K,a as W}from"./HeroSliderSkeleton-BU1A3nww.js";import{S as X,G as ee,T as te,Y as se}from"./TagFilter-C9cvn7kB.js";import{M as re}from"./MovieGrid-DX_rQINd.js";import{M as ae}from"./MovieGridSkeleton-QAQr21i1.js";import{P as ne}from"./Pagination-DYKWJTqm.js";import"./MovieCardSkeleton-DwbDPBAF.js";import"./useWatchLater-BnhS-TDe.js";const k=30,le=[{key:"foreign",label:"افلام اجنبي"},{key:"kurdish",label:"افلام كردي"},{key:"asian",label:"افلام اسيوية"},{key:"turkish",label:"افلام تركية"},{key:"arabic",label:"افلام عربي"},{key:"classic",label:"افلام كلاسيكيه"},{key:"dubbed",label:"افلام مدبلجة"},{key:"indian",label:"افلام هندية"},{key:"anime",label:"افلام انمي"}],$=async a=>{let l=[],c=0;const p=1e3;for(;;){const f=v.from("movies").select("*").order("created_at",{ascending:!1}).range(c,c+p-1);a==="kurdish"?f.or("movie_type.eq.kurdish,is_kurdish.is.true"):f.eq("movie_type",a);const{data:i,error:d}=await f;if(d)throw console.error(`Error fetching a batch of ${a} movies: `,d.message),d;if(i&&i.length>0){if(l=l.concat(i),i.length<p)break;c+=i.length}else break}return l},fe=()=>{var F;const{type:a}=V(),[l,c]=r.useState([]),[p,f]=r.useState([]),[i,d]=r.useState(!0),[C,N]=r.useState(null),[m,D]=r.useState("all"),[g,T]=r.useState([]),[u,M]=r.useState([]),[b,Y]=r.useState("createdAt_desc"),[x,q]=r.useState(""),[j,E]=Z(),P=r.useRef(!0),S=parseInt(j.get("page")||"1",10),h=((F=le.find(e=>e.key===a))==null?void 0:F.label)||"أفلام",G=r.useCallback(e=>{const t=new URLSearchParams(j);e<=1?t.delete("page"):t.set("page",e.toString()),E(t,{replace:!0}),window.scrollTo(0,0)},[j,E]);r.useEffect(()=>{(async()=>{var o;if(a){d(!0);try{const y=await $(a);c(y)}catch(y){console.error(`Error fetching ${a} movies: `,y);let _=`فشل تحميل أفلام ${h}. يرجى المحاولة مرة أخرى لاحقًا.`;y.code==="42501"?_="فشل تحميل الأفلام: أذونات غير كافية. تأكد من أن سياسات RLS في Supabase تسمح بالوصول للقراءة.":(o=y.message)!=null&&o.toLowerCase().includes("network")&&(_="فشل تحميل الأفلام: مشكلة في الشبكة. يرجى التحقق من اتصالك بالإنترنت."),N(_)}finally{d(!1)}}})();const t=a==="kurdish"?"movie_type=eq.kurdish,is_kurdish=is.true":`movie_type=eq.${a}`,n=v.channel(`public:movies:${a}`).on("postgres_changes",{event:"*",schema:"public",table:"movies",filter:t},()=>{a&&$(a).then(c).catch(o=>console.error("Error on subscription refetch:",o))}).subscribe();return()=>{v.removeChannel(n)}},[a,h]),r.useEffect(()=>{(async()=>{const{data:t,error:n}=await v.from("categories").select("name").order("name");n?(console.error("Error fetching categories: ",n.message),N(o=>(o?o+`
`:"")+"فشل تحميل الفئات.")):f(t.map(o=>o.name))})()},[]);const R=e=>{T(t=>t.includes(e)?t.filter(n=>n!==e):[...t,e])},H=()=>T([]),I=e=>M(t=>t.includes(e)?t.filter(n=>n!==e):[...t,e]),L=()=>M([]),z=[...new Set(l.map(e=>e.year))].sort((e,t)=>t-e),O=p,B=[...new Set(l.flatMap(e=>e.tags||[]))].sort(),w=r.useMemo(()=>l.filter(e=>m==="all"||e.year.toString()===m).filter(e=>g.length===0||g.some(t=>{var n;return(n=e.genres)==null?void 0:n.includes(t)})).filter(e=>u.length===0||u.some(t=>{var n;return(n=e.tags)==null?void 0:n.includes(t)})).filter(e=>J(x,e.title)).sort((e,t)=>{switch(b){case"rating_desc":return(t.imdb_rating??0)-(e.imdb_rating??0);case"rating_asc":return(e.imdb_rating??0)-(t.imdb_rating??0);case"year_desc":return t.year-e.year;case"year_asc":return e.year-t.year;case"createdAt_asc":return Number(new Date(e.created_at))-Number(new Date(t.created_at));case"createdAt_desc":default:return Number(new Date(t.created_at))-Number(new Date(e.created_at))}}),[l,m,g,u,x,b]);r.useEffect(()=>{if(P.current){P.current=!1;return}S!==1&&G(1)},[m,g,u,x,b]);const A=Math.ceil(w.length/k),Q=w.slice((S-1)*k,S*k),U=x!==""||m!=="all"||g.length>0||u.length>0||b!=="createdAt_desc";return i?s.jsxs("div",{children:[s.jsx(K,{}),s.jsx("div",{className:"my-8 h-20 bg-gray-800/50 rounded-lg animate-pulse"}),s.jsxs("section",{className:"mb-12",children:[s.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white mb-6 border-r-4 border-cyan-400 pr-4",children:h}),s.jsx(ae,{count:18})]})]}):C&&l.length===0?s.jsxs("div",{className:"text-center p-8 bg-red-900/20 border border-red-500/50 rounded-lg mt-8 animate-fade-in",children:[s.jsx("h2",{className:"text-2xl text-red-400 mb-4",children:"حدث خطأ في الاتصال بقاعدة البيانات"}),s.jsx("p",{className:"text-slate-300 whitespace-pre-line",children:C})]}):s.jsxs("div",{className:"animate-fade-in",children:[s.jsx(W,{movies:l.slice(0,5)}),s.jsx("div",{className:"relative z-30 my-8 flex justify-center items-center p-4 bg-slate-900/70 backdrop-blur-sm rounded-xl",children:s.jsxs("div",{className:"w-full grid grid-cols-1 sm:grid-cols-2 md:flex md:flex-row md:flex-wrap justify-center items-center gap-4",children:[s.jsx("input",{type:"text",value:x,onChange:e=>q(e.target.value),placeholder:`ابحث في ${h}...`,className:"w-full md:w-auto md:flex-grow bg-slate-700 text-white p-2 pl-4 rounded-md focus:ring-2 focus:ring-cyan-500 border-none outline-none","aria-label":"Search within this category"}),s.jsx(X,{sortOrder:b,onSortChange:Y}),s.jsx(ee,{genres:O,selectedGenres:g,onToggleGenre:R,onClearGenres:H}),s.jsx(te,{tags:B,selectedTags:u,onToggleTag:I,onClearTags:L}),s.jsx(se,{years:z,selectedYear:m,onYearChange:D})]})}),s.jsxs("section",{className:"mb-12",children:[s.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white mb-6 border-r-4 border-cyan-400 pr-4",children:U?`نتائج البحث في ${h}`:h}),w.length>0?s.jsxs(s.Fragment,{children:[s.jsx(re,{movies:Q}),A>1&&s.jsx(ne,{currentPage:S,totalPages:A,onPageChange:G})]}):s.jsx("div",{className:"text-center p-8 bg-gray-800 rounded-lg mt-8",children:s.jsx("p",{className:"text-xl text-gray-400",children:"لا توجد أفلام في هذه الفئة تطابق معايير البحث."})})]})]})};export{fe as default};
