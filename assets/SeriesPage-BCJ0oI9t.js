import{r,a as X,s as S,j as s}from"./index-ys7-kEXr.js";import{S as ee,G as te,T as se,Y as ae}from"./TagFilter-NSjgck_R.js";import{M as re}from"./MovieGridSkeleton-BvK8M1W5.js";import{P as ne}from"./Pagination-CZV0YIFB.js";import{S as le}from"./SeriesGrid-C0zu1IDT.js";import{a as ce,R as oe}from"./ResumeFromModal-3zH9B3Jx.js";import"./MovieCardSkeleton-y4teuH_d.js";import"./SpinnerIcon--GOSBvL4.js";const T=30,E="cached_series",ie=900*1e3,de=async()=>{let i=[],g=0;const x=1e3;for(;;){const{data:d,error:f}=await S.from("series").select("*").order("created_at",{ascending:!1}).range(g,g+x-1);if(f)throw console.error("Error fetching series batch:",f),f;if(d&&d.length>0){if(i=i.concat(d),d.length<x)break;g+=d.length}else break}return i},be=()=>{const[i,g]=r.useState([]),[x,d]=r.useState([]),[f,P]=r.useState(!0),[R,F]=r.useState(null),[m,u]=X(),A=r.useRef(!0),[l,b]=r.useState(()=>m.get("year")||"all"),[c,w]=r.useState(()=>{var e;return((e=m.get("genres"))==null?void 0:e.split(",").filter(Boolean))||[]}),[o,j]=r.useState(()=>{var e;return((e=m.get("tags"))==null?void 0:e.split(",").filter(Boolean))||[]}),[h,M]=r.useState(()=>m.get("sort")||"createdAt_desc"),{addWatchLaterSeries:D,removeWatchLaterSeries:W,isWatchLaterSeries:Y,getWatchLaterInfo:L,loading:O}=ce(),[p,y]=r.useState(null),C=parseInt(m.get("page")||"1",10),B=r.useCallback(e=>{const t=new URLSearchParams(m);e<=1?t.delete("page"):t.set("page",e.toString()),u(t),window.scrollTo(0,0)},[m,u]);r.useEffect(()=>{if(A.current){A.current=!1;return}const e=new URLSearchParams;l!=="all"&&e.set("year",l),c.length>0&&e.set("genres",c.join(",")),o.length>0&&e.set("tags",o.join(",")),h!=="createdAt_desc"&&e.set("sort",h),u(e,{replace:!0})},[l,c,o,h,u]),r.useEffect(()=>{(async()=>{var t;try{const a=localStorage.getItem(E);if(a){const{data:n,timestamp:_}=JSON.parse(a);if(new Date().getTime()-_<ie){g(n),P(!1);return}}}catch(a){console.error("Error reading from series cache",a),localStorage.removeItem(E)}try{const a=await de();g(a);try{const n={data:a,timestamp:new Date().getTime()};localStorage.setItem(E,JSON.stringify(n))}catch(n){console.error("Error writing to series cache",n)}}catch(a){console.error("Error fetching series: ",a);let n="فشل تحميل المسلسلات. يرجى المحاولة مرة أخرى لاحقًا.";a.code==="42501"?n="فشل تحميل المسلسلات: أذونات غير كافية. تأكد من أن سياسات RLS تسمح بالوصول للقراءة.":(t=a.message)!=null&&t.toLowerCase().includes("network")&&(n="فشل تحميل المسلسلات: مشكلة في الشبكة. يرجى التحقق من اتصالك بالإنترنت."),F(n)}finally{P(!1)}})()},[]),r.useEffect(()=>{const e=async()=>{const{data:a,error:n}=await S.from("categories").select("name").order("name");n?console.error("Error fetching categories: ",n):d(a.map(_=>_.name))};e();const t=S.channel("public:categories:series").on("postgres_changes",{event:"*",schema:"public",table:"categories"},e).subscribe();return()=>{S.removeChannel(t)}},[]);const k=e=>w(t=>t.includes(e)?t.filter(a=>a!==e):[...t,e]),H=()=>w([]),G=e=>j(t=>t.includes(e)?t.filter(a=>a!==e):[...t,e]),U=()=>j([]),$=()=>{b("all"),w([]),j([])},J=e=>{Y(e.id)?W(e.id):y(e)},z=(e,t)=>{p&&D(p.id,e,t),y(null)},K=[...new Set(i.map(e=>e.year))].sort((e,t)=>t-e),Z=x,q=[...new Set(i.flatMap(e=>e.tags||[]))].sort(),N=r.useMemo(()=>i.filter(e=>l==="all"||e.year.toString()===l).filter(e=>c.length===0||c.some(t=>{var a;return(a=e.genres)==null?void 0:a.includes(t)})).filter(e=>o.length===0||o.some(t=>{var a;return(a=e.tags)==null?void 0:a.includes(t)})).sort((e,t)=>{switch(h){case"rating_desc":return(t.imdb_rating??0)-(e.imdb_rating??0);case"rating_asc":return(e.imdb_rating??0)-(t.imdb_rating??0);case"year_desc":return t.year-e.year;case"year_asc":return e.year-t.year;case"createdAt_asc":return new Date(e.created_at).getTime()-new Date(t.created_at).getTime();case"createdAt_desc":default:return new Date(t.created_at).getTime()-new Date(e.created_at).getTime()}}),[i,l,c,o,h]),I=Math.ceil(N.length/T),v=N.slice((C-1)*T,C*T),Q=l!=="all"||c.length>0||o.length>0,V=r.useMemo(()=>new Map(v.map(e=>{const t=L(e.id);return[e.id,t?{season:t.season,episode:t.episode}:null]})),[v,L]);return f?s.jsxs("div",{className:"animate-fade-in",children:[s.jsx("h1",{className:"text-4xl font-black text-white mb-8 border-r-4 border-cyan-400 pr-4",children:"تصفح المسلسلات"}),s.jsx("div",{className:"my-8 h-20 bg-slate-800/50 rounded-lg animate-pulse"}),s.jsx(re,{count:18})]}):R?s.jsxs("div",{className:"text-center p-8 bg-red-900/20 border border-red-500/50 rounded-lg mt-8 animate-fade-in",children:[s.jsx("h2",{className:"text-2xl text-red-400 mb-4",children:"حدث خطأ"}),s.jsx("p",{className:"text-slate-300 whitespace-pre-line",children:R})]}):s.jsxs("div",{className:"animate-fade-in",children:[s.jsx(oe,{isOpen:!!p,onClose:()=>y(null),series:p,onSave:z,isSaving:O}),s.jsx("h1",{className:"text-4xl font-black text-white mb-8 border-r-4 border-cyan-400 pr-4",children:"تصفح المسلسلات"}),s.jsx("div",{className:"relative z-30 my-8 flex justify-center items-center p-4 bg-slate-900/70 backdrop-blur-sm rounded-xl",children:s.jsxs("div",{className:"w-full grid grid-cols-1 sm:grid-cols-2 md:flex md:flex-row md:flex-wrap justify-center items-center gap-4",children:[s.jsx(ee,{sortOrder:h,onSortChange:M}),s.jsx(te,{genres:Z,selectedGenres:c,onToggleGenre:k,onClearGenres:H}),s.jsx(se,{tags:q,selectedTags:o,onToggleTag:G,onClearTags:U}),s.jsx(ae,{years:K,selectedYear:l,onYearChange:b})]})}),Q&&s.jsxs("div",{className:"mb-8 flex flex-wrap items-center gap-3 rounded-lg bg-slate-800/50 p-3 animate-fade-in-down",children:[s.jsx("span",{className:"font-bold text-slate-300 mr-2 flex-shrink-0",children:"الفلاتر النشطة:"}),s.jsxs("div",{className:"flex flex-wrap items-center gap-2 flex-grow",children:[l!=="all"&&s.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["سنة: ",l,s.jsx("button",{onClick:()=>b("all"),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove year filter ${l}`,children:"×"})]}),c.map(e=>s.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:[e,s.jsx("button",{onClick:()=>k(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove genre filter ${e}`,children:"×"})]},e)),o.map(e=>s.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["#",e,s.jsx("button",{onClick:()=>G(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove tag filter ${e}`,children:"×"})]},e))]}),s.jsx("button",{onClick:$,className:"ml-auto text-sm font-bold text-red-500 hover:text-red-400 hover:underline flex-shrink-0 px-2",children:"مسح الكل"})]}),s.jsx("section",{className:"mb-12",children:N.length>0?s.jsxs(s.Fragment,{children:[s.jsx(le,{series:v,onToggleWatchLater:J,watchLaterInfoMap:V}),I>1&&s.jsx(ne,{currentPage:C,totalPages:I,onPageChange:B})]}):s.jsx("div",{className:"text-center p-8 bg-slate-800 rounded-lg mt-8",children:s.jsx("p",{className:"text-xl text-slate-400",children:"لا توجد مسلسلات تطابق معايير البحث."})})})]})};export{be as default};
