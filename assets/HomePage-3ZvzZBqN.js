import{r as n,u as te,a as se,s as g,f as re,j as t}from"./index-hd9gIHiW.js";import{H as ae,a as ne}from"./HeroSliderSkeleton-B7eY-9E6.js";import{M as k}from"./MoviesCarousel-B19SL_RL.js";import{S as le,G as oe,T as ie,Y as ce}from"./TagFilter-D-_E6ere.js";import{u as de}from"./useWatchLater-uhBF2_Bm.js";import{M as me}from"./MovieGrid-O558wp-q.js";import{M as ue}from"./MovieGridSkeleton-bxSHR1Ls.js";import{M as E}from"./MoviesCarouselSkeleton-Ckj-dRom.js";import{P as ge}from"./Pagination--g5Tz_zB.js";import"./MovieCardSkeleton-CZ5m9Z9X.js";const A=30,z=async()=>{let o=[],h=0;const p=1e3;for(;;){const{data:d,error:x}=await g.from("movies").select("*").or("movie_type.eq.foreign,movie_type.is.null").order("created_at",{ascending:!1}).range(h,h+p-1);if(x)throw console.error("Error fetching a batch of movies: ",x.message),x;if(d&&d.length>0){if(o=o.concat(d),d.length<p)break;h+=d.length}else break}return o},Ce=()=>{const[o,h]=n.useState([]),[p,d]=n.useState([]),[x,P]=n.useState(!0),[G,F]=n.useState(null),[c,v]=n.useState("all"),[m,y]=n.useState([]),[u,j]=n.useState([]),[S,B]=n.useState("createdAt_desc"),[f,C]=n.useState(""),{currentUser:R}=te(),{favorites:O}=de(),[b,T]=se(),N=n.useRef(null),I=n.useRef(!0),w=parseInt(b.get("page")||"1",10),L=n.useCallback(e=>{var r;const s=new URLSearchParams(b);e<=1?s.delete("page"):s.set("page",e.toString()),T(s,{replace:!0}),(r=document.getElementById("filters-section"))==null||r.scrollIntoView({behavior:"smooth",block:"start"})},[b,T]);n.useEffect(()=>{const e=document.title,s=document.querySelector('meta[name="description"]'),r=(s==null?void 0:s.getAttribute("content"))||"",a=document.querySelector('meta[name="keywords"]'),i=(a==null?void 0:a.getAttribute("content"))||"";let l=document.querySelector('link[rel="canonical"]');return l||(l=document.createElement("link"),l.setAttribute("rel","canonical"),document.head.appendChild(l)),document.title="افلام | مشاهدة وتحميل أحدث الأفلام والمسلسلات",s==null||s.setAttribute("content","تطبيق ويب لمشاهدة وتحميل أحدث الأفلام والمسلسلات العربية والأجنبية المترجمة والمدبلجة."),a==null||a.setAttribute("content","افلام, مسلسلات, مشاهدة افلام, تحميل افلام, افلام اون لاين, افلام عربي, افلام اجنبي, افلام مترجمة"),l.setAttribute("href","https://afllami.netlify.app/#/"),()=>{document.title=e,s==null||s.setAttribute("content",r),a==null||a.setAttribute("content",i),l==null||l.remove()}},[]),n.useEffect(()=>{(async()=>{var r;P(!0);try{const a=await z();h(a)}catch(a){let i="فشل تحميل الأفلام. يرجى المحاولة مرة أخرى لاحقًا.";a.code==="42501"?i="فشل تحميل الأفلام: أذونات غير كافية. تأكد من أن سياسات RLS في Supabase تسمح بالوصول للقراءة.":(r=a.message)!=null&&r.toLowerCase().includes("network")&&(i="فشل تحميل الأفلام: مشكلة في الشبكة. يرجى التحقق من اتصالك بالإنترنت."),F(i),console.error("Error fetching movies: ",a.message)}finally{P(!1)}})();const s=g.channel("public:movies").on("postgres_changes",{event:"*",schema:"public",table:"movies"},()=>{z().then(h).catch(r=>console.error("Error refetching movies on subscription:",r.message))}).subscribe();return()=>{g.removeChannel(s)}},[]),n.useEffect(()=>{(async()=>{var i;const{data:r,error:a}=await g.from("categories").select("name").order("name");if(a){console.error("Error fetching categories: ",a.message);let l="فشل تحميل الفئات.";a.code==="42501"?l="فشل تحميل الفئات: أذونات غير كافية.":(i=a.message)!=null&&i.toLowerCase().includes("network")&&(l="فشل تحميل الفئات: مشكلة في الشبكة."),F(U=>U?`${U}
${l}`:l)}else d(r.map(l=>l.name))})();const s=g.channel("public:categories").on("postgres_changes",{event:"*",schema:"public",table:"categories"},()=>{g.from("categories").select("name").order("name").then(({data:r,error:a})=>{a?console.error("Error refetching categories on subscription:",a.message):r&&d(r.map(i=>i.name))})}).subscribe();return()=>{g.removeChannel(s)}},[]);const Y=e=>{y(s=>s.includes(e)?s.filter(r=>r!==e):[...s,e])},V=()=>{y([])},q=e=>{j(s=>s.includes(e)?s.filter(r=>r!==e):[...s,e])},D=()=>{j([])},Q=()=>{C(""),v("all"),y([]),j([]),N.current=null},H=o.filter(e=>O.includes(e.id)),Z=o.slice(0,15),J=[...o].sort((e,s)=>(s.imdb_rating??0)-(e.imdb_rating??0)).slice(0,15),W=[...new Set(o.map(e=>e.year))].sort((e,s)=>s-e),X=p,K=[...new Set(o.flatMap(e=>e.tags||[]))].sort(),_=n.useMemo(()=>o.filter(e=>c==="all"||e.year.toString()===c).filter(e=>m.length===0?!0:m.some(s=>{var r;return(r=e.genres)==null?void 0:r.includes(s)})).filter(e=>u.length===0?!0:u.some(s=>{var r;return(r=e.tags)==null?void 0:r.includes(s)})).filter(e=>re(f,e.title)).sort((e,s)=>{switch(S){case"rating_desc":return(s.imdb_rating??0)-(e.imdb_rating??0);case"rating_asc":return(e.imdb_rating??0)-(s.imdb_rating??0);case"year_desc":return s.year-e.year;case"year_asc":return e.year-s.year;case"createdAt_asc":return new Date(e.created_at).getTime()-new Date(s.created_at).getTime();case"createdAt_desc":default:return new Date(s.created_at).getTime()-new Date(e.created_at).getTime()}}),[o,c,m,u,f,S]);n.useEffect(()=>{if(I.current){I.current=!1;return}w!==1&&L(1)},[c,m,u,f,S]),n.useEffect(()=>{var s;const e=b.get("genre");e&&e!==N.current&&(C(""),v("all"),j([]),y([e]),N.current=e,(s=document.getElementById("filters-section"))==null||s.scrollIntoView({behavior:"smooth",block:"start"}))},[b]);const $=Math.ceil(_.length/A),ee=_.slice((w-1)*A,w*A),M=f!==""||c!=="all"||m.length>0||u.length>0;return x?t.jsxs("div",{children:[t.jsx(ae,{}),t.jsx("div",{className:"my-8 h-20 bg-gray-800/50 rounded-lg animate-pulse"}),R&&t.jsx(E,{title:"المفضلة"}),t.jsx(E,{title:"أحدث الإضافات"}),t.jsx(E,{title:"الأعلى تقييماً"}),t.jsxs("section",{className:"mb-12",children:[t.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white mb-6 border-r-4 border-cyan-400 pr-4",children:"تصفح الكل"}),t.jsx(ue,{count:18})]})]}):G&&o.length===0?t.jsxs("div",{className:"text-center p-8 bg-red-900/20 border border-red-500/50 rounded-lg mt-8 animate-fade-in",children:[t.jsx("h2",{className:"text-2xl text-red-400 mb-4",children:"حدث خطأ في الاتصال بقاعدة البيانات"}),t.jsx("p",{className:"text-slate-300 whitespace-pre-line",children:G}),t.jsx("p",{className:"text-slate-400 mt-4",children:"This usually means the database tables are not set up correctly or Row Level Security (RLS) is preventing access. Please check your Supabase dashboard to ensure the 'movies' and 'categories' tables are readable by anonymous users."})]}):t.jsxs("div",{className:"animate-fade-in",children:[t.jsx(ne,{movies:o.slice(0,5)}),t.jsx("div",{id:"filters-section",className:"relative z-30 my-8 flex justify-center items-center p-4 bg-slate-900/70 backdrop-blur-sm rounded-xl scroll-mt-20",children:t.jsxs("div",{className:"w-full grid grid-cols-1 sm:grid-cols-2 md:flex md:flex-row md:flex-wrap justify-center items-center gap-4",children:[t.jsx(le,{sortOrder:S,onSortChange:B}),t.jsx(oe,{genres:X,selectedGenres:m,onToggleGenre:Y,onClearGenres:V}),t.jsx(ie,{tags:K,selectedTags:u,onToggleTag:q,onClearTags:D}),t.jsx(ce,{years:W,selectedYear:c,onYearChange:v})]})}),M&&t.jsxs("div",{className:"mb-8 flex flex-wrap items-center gap-3 rounded-lg bg-gray-800/50 p-3 animate-fade-in-down",children:[t.jsx("span",{className:"font-bold text-gray-300 mr-2 flex-shrink-0",children:"الفلاتر النشطة:"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 flex-grow",children:[f&&t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-yellow-900/50 px-3 py-1 text-sm text-yellow-300",children:['بحث: "',f,'"',t.jsx("button",{onClick:()=>C(""),className:"text-yellow-400 hover:text-white text-lg leading-none font-bold","aria-label":"Clear search query",children:"×"})]}),c!=="all"&&t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["سنة: ",c,t.jsx("button",{onClick:()=>v("all"),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove year filter ${c}`,children:"×"})]}),m.map(e=>t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:[e,t.jsx("button",{onClick:()=>Y(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove genre filter ${e}`,children:"×"})]},e)),u.map(e=>t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["#",e,t.jsx("button",{onClick:()=>q(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove tag filter ${e}`,children:"×"})]},e))]}),t.jsx("button",{onClick:Q,className:"ml-auto text-sm font-bold text-red-500 hover:text-red-400 hover:underline flex-shrink-0 px-2",children:"مسح الكل"})]}),!M&&t.jsxs(t.Fragment,{children:[R&&H.length>0&&t.jsx(k,{title:"المفضلة",movies:H}),t.jsx(k,{title:"أحدث الإضافات",movies:Z}),t.jsx(k,{title:"الأعلى تقييماً",movies:J})]}),t.jsxs("section",{className:"mb-12",children:[t.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white mb-6 border-r-4 border-cyan-400 pr-4",children:M?"نتائج البحث":"تصفح الكل"}),_.length>0?t.jsxs(t.Fragment,{children:[t.jsx(me,{movies:ee}),$>1&&t.jsx(ge,{currentPage:w,totalPages:$,onPageChange:L})]}):t.jsx("div",{className:"text-center p-8 bg-gray-800 rounded-lg mt-8",children:t.jsx("p",{className:"text-xl text-gray-400",children:"لا توجد أفلام تطابق معايير البحث."})})]})]})};export{Ce as default};
